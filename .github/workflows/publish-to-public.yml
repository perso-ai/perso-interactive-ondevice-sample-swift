name: Publish to Public Repo

on:
  push:
    tags:
      - 'publish-*'

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Push to public repo
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.DEPLOY_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan github.com >> ~/.ssh/known_hosts

          export GIT_SSH_COMMAND="ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no"

          git config user.name "Perso.Interactive"
          git config user.email "Perso.Interactive@estsoft.com"

          PUBLIC_REPO="git@github.com:perso-ai/perso-interactive-ondevice-sample-swift.git"
          git clone --depth=1 $PUBLIC_REPO public-repo || {
            git init public-repo
            cd public-repo
            git remote add origin $PUBLIC_REPO
            cd ..
          }

          cd public-repo
          rsync -a --delete --exclude='.git' --exclude='.github' ../ ./

          git add -A
          git diff --cached --quiet && echo "No changes to publish" && exit 0
          git commit -m "update sample"
          git push --force
